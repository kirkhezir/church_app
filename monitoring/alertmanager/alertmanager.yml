# Alertmanager Configuration
# ============================================

global:
  # SMTP settings for email alerts
  smtp_smarthost: "smtp.gmail.com:587"
  smtp_from: "alerts@church-app.local"
  smtp_auth_username: "${SMTP_USER}"
  smtp_auth_password: "${SMTP_PASSWORD}"

  # Slack webhook URL
  slack_api_url: "${SLACK_WEBHOOK_URL}"

  # Default settings
  resolve_timeout: 5m

# Alert templates
templates:
  - "/etc/alertmanager/templates/*.tmpl"

# Routing tree
route:
  # Default receiver
  receiver: "default-receiver"

  # Group alerts by these labels
  group_by: ["alertname", "severity", "instance"]

  # Wait time before sending first notification
  group_wait: 30s

  # Wait time before sending new alerts
  group_interval: 5m

  # Re-send notifications interval
  repeat_interval: 4h

  # Child routes
  routes:
    # Critical alerts - immediate notification
    - match:
        severity: critical
      receiver: "critical-receiver"
      group_wait: 10s
      repeat_interval: 1h

    # Warning alerts
    - match:
        severity: warning
      receiver: "warning-receiver"
      group_wait: 1m
      repeat_interval: 4h

# Receivers
receivers:
  # Default receiver
  - name: "default-receiver"
    email_configs:
      - to: "admin@church-app.local"
        send_resolved: true

  # Critical alerts - email + Slack
  - name: "critical-receiver"
    email_configs:
      - to: "admin@church-app.local,oncall@church-app.local"
        send_resolved: true
        headers:
          Subject: "ðŸš¨ CRITICAL: {{ .GroupLabels.alertname }}"
    slack_configs:
      - channel: "#alerts-critical"
        send_resolved: true
        title: '{{ if eq .Status "firing" }}ðŸš¨{{ else }}âœ…{{ end }} {{ .GroupLabels.alertname }}'
        text: >-
          {{ range .Alerts }}
          *Alert:* {{ .Annotations.summary }}
          *Description:* {{ .Annotations.description }}
          *Severity:* {{ .Labels.severity }}
          *Instance:* {{ .Labels.instance }}
          {{ end }}

  # Warning alerts - Slack only
  - name: "warning-receiver"
    slack_configs:
      - channel: "#alerts-warning"
        send_resolved: true
        title: '{{ if eq .Status "firing" }}âš ï¸{{ else }}âœ…{{ end }} {{ .GroupLabels.alertname }}'
        text: >-
          {{ range .Alerts }}
          *Alert:* {{ .Annotations.summary }}
          *Description:* {{ .Annotations.description }}
          {{ end }}

# Inhibition rules
inhibit_rules:
  # Inhibit warning alerts when critical alert is firing
  - source_match:
      severity: "critical"
    target_match:
      severity: "warning"
    equal: ["alertname", "instance"]
