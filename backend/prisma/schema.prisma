generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model announcements {
  id                        String                      @id
  title                     String
  content                   String
  priority                  Priority                    @default(NORMAL)
  authorId                  String
  publishedAt               DateTime                    @default(now())
  archivedAt                DateTime?
  isDraft                   Boolean                     @default(false)
  createdAt                 DateTime                    @default(now())
  updatedAt                 DateTime
  deletedAt                 DateTime?
  members                   members                     @relation(fields: [authorId], references: [id])
  member_announcement_views member_announcement_views[]

  @@index([archivedAt, publishedAt])
  @@index([authorId])
  @@index([isDraft, publishedAt])
  @@index([publishedAt(sort: Desc)])
}

model audit_logs {
  id         String   @id
  userId     String
  action     String
  entityType String
  entityId   String
  changes    Json?
  ipAddress  String
  userAgent  String
  timestamp  DateTime @default(now())
  members    members  @relation(fields: [userId], references: [id])

  @@index([entityType, entityId])
  @@index([userId, timestamp])
}

model event_rsvps {
  id        String     @id
  eventId   String
  memberId  String
  status    RSVPStatus @default(CONFIRMED)
  rsvpedAt  DateTime   @default(now())
  updatedAt DateTime
  events    events     @relation(fields: [eventId], references: [id], onDelete: Cascade)
  members   members    @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@unique([eventId, memberId])
  @@index([eventId])
}

model events {
  id            String        @id
  title         String
  description   String
  startDateTime DateTime
  endDateTime   DateTime
  location      String
  category      EventCategory
  maxCapacity   Int?
  imageUrl      String?
  createdById   String
  createdAt     DateTime      @default(now())
  updatedAt     DateTime
  cancelledAt   DateTime?
  deletedAt     DateTime?
  event_rsvps   event_rsvps[]
  members       members       @relation(fields: [createdById], references: [id])

  @@index([createdById])
  @@index([startDateTime, category])
}

model member_announcement_views {
  id             String        @id
  memberId       String
  announcementId String
  viewedAt       DateTime      @default(now())
  announcements  announcements @relation(fields: [announcementId], references: [id])
  members        members       @relation(fields: [memberId], references: [id])

  @@unique([memberId, announcementId])
}

model members {
  id                                     String                      @id
  email                                  String                      @unique
  passwordHash                           String
  firstName                              String
  lastName                               String
  phone                                  String?
  address                                String?
  dateOfBirth                            DateTime?
  role                                   Role                        @default(MEMBER)
  membershipDate                         DateTime
  privacySettings                        Json
  emailNotifications                     Boolean                     @default(true)
  accountLocked                          Boolean                     @default(false)
  lockedUntil                            DateTime?
  failedLoginAttempts                    Int                         @default(0)
  lastLoginAt                            DateTime?
  mfaEnabled                             Boolean                     @default(false)
  mfaSecret                              String?
  backupCodes                            Json?
  passwordResetToken                     String?
  passwordResetExpires                   DateTime?
  createdAt                              DateTime                    @default(now())
  updatedAt                              DateTime
  deletedAt                              DateTime?
  announcements                          announcements[]
  audit_logs                             audit_logs[]
  event_rsvps                            event_rsvps[]
  events                                 events[]
  member_announcement_views              member_announcement_views[]
  messages_messages_recipientIdTomembers messages[]                  @relation("messages_recipientIdTomembers")
  messages_messages_senderIdTomembers    messages[]                  @relation("messages_senderIdTomembers")
  push_subscriptions                     push_subscriptions[]
  user_sessions                          user_sessions[]

  @@index([email])
  @@index([membershipDate])
  @@index([role])
}

model messages {
  id                                    String    @id
  senderId                              String
  recipientId                           String
  subject                               String
  body                                  String
  isRead                                Boolean   @default(false)
  readAt                                DateTime?
  sentAt                                DateTime  @default(now())
  deletedBySender                       Boolean   @default(false)
  deletedByRecipient                    Boolean   @default(false)
  members_messages_recipientIdTomembers members   @relation("messages_recipientIdTomembers", fields: [recipientId], references: [id])
  members_messages_senderIdTomembers    members   @relation("messages_senderIdTomembers", fields: [senderId], references: [id])

  @@index([recipientId, isRead])
  @@index([senderId, sentAt])
}

model push_subscriptions {
  id        String   @id
  memberId  String
  endpoint  String
  p256dh    String   @db.VarChar(500)
  auth      String   @db.VarChar(100)
  createdAt DateTime @default(now())
  updatedAt DateTime
  members   members  @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@unique([memberId, endpoint])
  @@index([memberId])
}

model user_sessions {
  id           String    @id
  memberId     String
  sessionStart DateTime  @default(now())
  sessionEnd   DateTime?
  duration     Int?
  userAgent    String?
  ipAddress    String?
  members      members   @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([memberId, sessionStart])
  @@index([sessionStart])
}

enum EventCategory {
  WORSHIP
  BIBLE_STUDY
  COMMUNITY
  FELLOWSHIP
}

enum Priority {
  URGENT
  NORMAL
}

enum RSVPStatus {
  CONFIRMED
  WAITLISTED
  CANCELLED
}

enum Role {
  ADMIN
  STAFF
  MEMBER
}
